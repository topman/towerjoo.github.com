<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="author" content="towerjoo" />
<meta name="keywords" content="技术,admin,django,python,代码,研究" />
<title> Django研究之admin系统(二） / 找寻模式</title>
<link href="http://towerjoo.github.com/feed.xml" rel="alternate" title="找寻模式" type="application/atom+xml" />

<link rel="stylesheet" type="text/css" href="/assets/css/stylesheet.css" media="screen" />
<link rel="stylesheet" type="text/css" href="/assets/css/pygment_trac.css" media="screen" />
<link rel="stylesheet" type="text/css" href="/assets/css/print.css" media="print" />
</head>

<body>



<div class="container">
<section id="main_content">

<header>
	<h1><a href="/" class="minor">找寻模式</a> / Django研究之admin系统(二）
        </h1>
	<p class="additional">阅读, 人生, 技术</p>
    <div id="header_nav">
    <a href="/category.html">Category</a>
    <a href="/archive.html">Archive</a>
    <a href="/projects.html">Projects</a>
    <a href="/links.html">Links</a>
    <a href="/about.html">About</a>
    </div>
    <div id="search_box">
    <form action="/search/" class="block block-search">
    <input type="search" name="q" placeholder="回车搜索" />
    </form>
    </div>
</header>


<article>
	<h1><a href="/blog/2011/03/09/django%E7%A0%94%E7%A9%B6%E4%B9%8Badmin%E7%B3%BB%E7%BB%9F%E4%BA%8C%EF%BC%89">Django研究之admin系统(二）</a></h1>
	
	<p class="meta">
	<span class="datetime">2011-03-09</span> posted in [<a href="/category/tech" class="category">技术模式</a>] with tags: [技术, admin, django, python, 代码, and 研究]
</p>

	接着 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 的内容，本文将基于自己的理解尝试回答 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 中研究列表中的3和4，即：
<ol class="arabic simple">
	<li>理解和分析Admin系统的设计和代码书写值得学习和注意的问题</li>
	<li>总结</li>
</ol>
<div id="admin" class="section">
<h1>理解和分析Admin系统的设计和代码书写</h1>
Admin系统具有多种特征，首先它是一个普通的 <a class="reference external" href="http://djangoproject.com">Django</a> 应用，其次它又承担 作为各个其它Djago应用的基础应用而存在，所以我们可以从上面两个方面 来加以分析。
<div id="id1" class="section">
<h2>作为一个普通的应用</h2>
<a class="reference external" href="http://djangoproject.com">Django</a> 本身是一个基于MVC的web框架，各个层次非常清楚，当然在 <a class="reference external" href="http://djangoproject.com">Django</a> 中，更多地被 称为MTV，即Model, Template, View，对应于MVC的Model, View, Controller。 其中Template和View的衔接是通过url映射完成，而url映射也是 <a class="reference external" href="http://djangoproject.com">Django</a> 架构中最为巧妙的 地方。

<img src="http://towerjoo.blog.techweb.com.cn/wp-content/blogs.dir/14215/files/blog/django_layers.png" alt="http://towerjoo.blog.techweb.com.cn/wp-content/blogs.dir/14215/files/blog/django_layers.png" />对于一个 <a class="reference external" href="http://djangoproject.com">Django</a> 的应用，我们通常可以从url映射入手，找到url处理的函数，和渲染出的页面， 从而理清整个的应用逻辑。
<blockquote><a class="reference external" href="http://djangoproject.com">Django</a> 的Admin应用的url映射大致如下：</blockquote>
<pre># sites.py
urlpatterns = patterns('',
    url(r'^$',
        wrap(self.index),
        name='index'),
    url(r'^logout/$',
        wrap(self.logout),
        name='logout'),
    url(r'^password_change/$',
        wrap(self.password_change, cacheable=True),
        name='password_change'),
    url(r'^password_change/done/$',
        wrap(self.password_change_done, cacheable=True),
        name='password_change_done'),
    url(r'^jsi18n/$',
        wrap(self.i18n_javascript, cacheable=True),
        name='jsi18n'),
    url(r'^r/(?P&lt;content_type_id&gt;\d+)/(?P&lt;object_id&gt;.+)/$',
        'django.views.defaults.shortcut'),
    url(r'^(?P&lt;app_label&gt;\w+)/$',
        wrap(self.app_index),
        name='app_list')
    )

# Add in each model's views.
for model, model_admin in self._registry.iteritems():
    urlpatterns += patterns('',
        url(r'^%s/%s/' % (model._meta.app_label, model._meta.module_name),
                include(model_admin.urls))
    )</pre>
从上面的代码，我们可以看到，Admin应用的landing page，登出，密码修改等相应的逻辑， 重点查看最后几行代码，将已经注册的应用的model(数据库的表)相应url映射指向了其自身的方法。

我们来看model_admin.urls这个逻辑：
<pre>urlpatterns = patterns('',
    url(r'^$',
        wrap(self.changelist_view),
        name='%s_%s_changelist' % info),
    url(r'^add/$',
        wrap(self.add_view),
        name='%s_%s_add' % info),

    # added by Tower Joo At 2011/2/27
    # have to be ahead of change_view unless it will be overrided
    url(r'^export/$',
        wrap(self.export),
        name='%s_%s_export' % info),
    url(r'^aggregate/$',
        wrap(self.aggregate),
        name='%s_%s_aggregate' % info),

    url(r'^(.+)/history/$',
        wrap(self.history_view),
        name='%s_%s_history' % info),
    url(r'^(.+)/delete/$',
        wrap(self.delete_view),
        name='%s_%s_delete' % info),
    url(r'^(.+)/$',
            wrap(self.change_view),
            name='%s_%s_change' % info),
    )</pre>
从上面的url映射来看，已经包含了增加记录，删除记录，修改记录等操作，当然上面也包含了 在 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 中我做的一些url映射的修改。

看过上面的url映射后，心里就会有数，知道整个Admin系统大致有多少个页面，各个页面的作用是什么。

然后，我们可以通过url映射知道处理这个url的函数，例如，处理/add/的self.add_view函数。 通过阅读self.add_view函数的代码，除了相比于我们通常的逻辑更多的边界和条件处理外，其它的 也是相同的，例如数据库的操作，页面渲染所需要的数据准备等。

<dl><dt>最后，我们看到的是页面渲染所需要的Template, change_form.html，查看对应的代码，则与通常的</dt><dd><a class="reference external" href="http://djangoproject.com">Django</a> 的Template并无二异。</dd></dl>其它的逻辑也相同。相比于我们自己的 <a class="reference external" href="http://djangoproject.com">Django</a> 应用，这个逻辑中有更多的边界条件的处理和异常的处理 等，你可能会说它过于复杂，这也就引入了我们接下来要说明的第二个问题。</div>
<div id="id2" class="section">
<h2>作为其它应用的通用基础应用</h2>
作为一个基础的应用，它就需要适应所有基于其上的其它应用的需要。 通用性通常意味着更多的复杂性，我们来看 <a class="reference external" href="http://djangoproject.com">Django</a> 是如何有效且优美地处理这个问题的。
<ol class="arabic simple">
	<li>充分使用Python的内省，也即model的元数据，如app_label, module_name等，使得动态地构造url映射 和合适的显示成为可能</li>
	<li>admin = AdminSite()是一个全局的变量，来维护所有的注册应用的列表</li>
	<li>两级的处理结构：admin site级和table级，分别由两个类来处理，并完成相应的url映射</li>
	<li>可配置性：对于其上层的应用，都提供了完善的可override的属性，如list_display,list_filter等等</li>
	<li>使用类而非 <a class="reference external" href="http://djangoproject.com">Django</a> 默认推荐的函数作为view的处理，这样就提供了用户基于Admin系统建立自己的Admin系统的可能</li>
</ol>
</div>
</div>
<div id="id3" class="section">
<h1>总结</h1>
Admin系统可谓是 <a class="reference external" href="http://djangoproject.com">Django</a> 最强大的功能了,它也大大方便了数据库驱动的应用的开发难度,为应用的数据输入,管理等 提供了一个稳定,可靠,方便的管理界面.

从 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 和本文的介绍中,我们可以从中学习到一些 <a class="reference external" href="http://djangoproject.com">Django</a> 常用的开发技巧:
<ol class="arabic simple">
	<li>基于类的view实现(当然在 <a class="reference external" href="http://djangoproject.com">Django</a> 已经完全支持class view了, 参考 <a class="reference external" href="http://docs.djangoproject.com/en/dev/topics/class-based-views/">Class-based generic views</a> )</li>
	<li>分级的数据处理</li>
	<li>可配置性</li>
	<li>灵活性</li>
</ol>
会使用 <a class="reference external" href="http://djangoproject.com">Django</a> 的Admin系统那可以让你的工作时间节省30%以上(基于数据库的应用),如果能够弄清楚 <a class="reference external" href="http://djangoproject.com">Django</a> Admin 的实现原理并从中学习到可用于自己实际开发的经验与方法,则可运筹帷幄,谈笑风生地写代码了.
<div><a href="/assets/images/yunchou.jpg"><img class="alignnone size-medium wp-image-124" src="/assets/images/yunchou.jpg" alt="" width="300" height="296" /></a></div>
</div>

	
	<!--<p class="permalink">永久链接：<a href="http://towerjoo.github.com/blog/2011/03/09/django%E7%A0%94%E7%A9%B6%E4%B9%8Badmin%E7%B3%BB%E7%BB%9F%E4%BA%8C%EF%BC%89">http://towerjoo.github.com/blog/2011/03/09/django%E7%A0%94%E7%A9%B6%E4%B9%8Badmin%E7%B3%BB%E7%BB%9F%E4%BA%8C%EF%BC%89</a></p>-->
</article>
<div id="disqus_thread" class="comments"></div>
<!-- JiaThis Button BEGIN -->
<script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jiathis_r.js?move=0&amp;btn=r2.gif&amp;uid=89469" charset="utf-8"></script>
<!-- JiaThis Button END -->

<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'towerjoo'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</section>
</div>

<footer>
		<p>&copy; Since 2012 <a href="http://github.com/towerjoo" target="_blank">github.com/towerjoo</a></p>
</footer>

<div id="side_top">
    <a href="#">Top</a>
</div>

</body>
</html>
